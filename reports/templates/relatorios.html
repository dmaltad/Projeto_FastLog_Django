{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/relatorios.css' %}">
    <style>
        .page-break {
            page-break-after: always;
        }

        @media print {
            body {
                background-color: #fff !important;
            }

            .navbar,
            .btn,
            .d-flex.gap-2 {
                display: none !important;
            }

            .card {
                border: 1px solid #ccc !important;
                margin-bottom: 2rem !important;
            }

            .card-header,
            .card-body {
                border-bottom: 1px solid #ccc;
            }
        }

        /* Ajuste para melhor visualização em telas pequenas */
        @media (max-width: 991.98px) {
            .navbar-nav {
                flex-direction: column;
                align-items: flex-start;
            }

            .d-flex.gap-2 {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Regras de responsividade para a tabela */
        @media (max-width: 767.98px) {
            /* Oculta o cabeçalho da tabela */
            .table thead {
                display: none;
            }

            /* Faz com que cada linha da tabela se comporte como um bloco */
            .table tbody tr {
                display: block;
                margin-bottom: 1.5rem;
                border: 1px solid #dee2e6;
                border-radius: .25rem;
                padding: 1rem;
            }

            /* Faz com que cada célula da tabela se comporte como um bloco */
            .table td {
                display: block;
                text-align: right !important;
                padding-left: 50% !important;
                position: relative;
            }

            /* Cria a "etiqueta" com o nome da coluna */
            .table td::before {
                content: attr(data-label);
                position: absolute;
                left: 1rem;
                width: calc(50% - 1.5rem);
                text-align: left;
                font-weight: bold;
            }

            /* Esconde o total do rodapé da tabela em telas pequenas */
            .table tfoot tr {
                display: none;
            }
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient-custom shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="{% url 'painel' %}">
                <i class="fas fa-chart-line me-2"></i> Painel Cliente
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link active fw-bold" aria-current="page" href="{% url 'painel' %}">
                            <i class="fas fa-tachometer-alt me-1"></i> Painel
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'pedidos' %}">
                            <i class="fas fa-shopping-cart me-1"></i> Pedidos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'entregadores' %}">
                            <i class="fas fa-motorcycle me-1"></i> Entregadores
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'relatorios' %}">
                            <i class="fas fa-chart-bar me-1"></i> Relatórios
                        </a>
                    </li>
                </ul>
                <div class="d-flex ms-auto">
                    <div class="dropdown">
                        <button class="btn btn-outline-light rounded-pill dropdown-toggle" type="button"
                            id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> Olá, Usuário
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <!-- <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog me-2"></i> Perfil</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Configurações</a></li>
                            <li><hr class="dropdown-divider"></li> -->
                            <li><a class="dropdown-item" href="{% url 'login' %}"><i class="fas fa-sign-out-alt me-2"></i>
                                    Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0 text-dark fw-bold">Relatórios</h1>
            <div class="d-flex flex-column flex-lg-row gap-2 align-items-center">
                <div class="d-flex flex-column flex-lg-row align-items-center gap-2">
                    <label for="dataInicial" class="form-label mb-0 fw-bold">De:</label>
                    <input type="date" class="form-control" id="dataInicial">
                    <label for="dataFinal" class="form-label mb-0 fw-bold">Até:</label>
                    <input type="date" class="form-control" id="dataFinal">
                </div>
                <button class="btn btn-primary" onclick="window.print();">
                    <i class="fas fa-print me-2"></i> Imprimir
                </button>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Desempenho dos Entregadores</h5>
            </div>
            <div class="card-body" id="entregadoresCard">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="filtroNomeEntregador"
                        placeholder="Filtrar por nome do entregador...">
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr class="table-dark">
                                <th>ID do Pedido</th>
                                <th>Data</th>
                                <th>Entregador</th>
                                <th>Status</th>
                                <th>Taxa</th>
                            </tr>
                        </thead>
                        <tbody id="entregadoresTableBody">
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <th colspan="4">Total de Taxas</th>
                                <th id="totalTaxasEntregadores">R$ 0,00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dados de exemplo detalhados
        const entregadores = [
            { id: 1, nome: 'Pedro' },
            { id: 2, nome: 'Ana' },
            { id: 3, nome: 'Carlos' },
        ];

        // Simulação de pedidos com data e ID do entregador
        const pedidos = [
            // Dados para os últimos 7 dias
            { id: 101, data: '2025-09-08', entregadorId: 1, taxa: 8.50, status: 'Entregue' },
            { id: 102, data: '2025-09-08', entregadorId: 2, taxa: 7.50, status: 'Entregue' },
            { id: 103, data: '2025-09-08', entregadorId: 1, taxa: 8.00, status: 'Aguardando Coleta' },
            { id: 104, data: '2025-09-07', entregadorId: 3, taxa: 6.00, status: 'Cancelado' },
            { id: 105, data: '2025-09-07', entregadorId: 2, taxa: 9.00, status: 'Entregue' },
            { id: 106, data: '2025-09-06', entregadorId: 1, taxa: 7.00, status: 'Entregue' },
            { id: 107, data: '2025-09-06', entregadorId: 1, taxa: 7.50, status: 'Entregue' },
            { id: 108, data: '2025-09-05', entregadorId: 3, taxa: 8.00, status: 'Entregue' },
            { id: 109, data: '2025-09-05', entregadorId: 2, taxa: 6.50, status: 'Em Trânsito' },
            { id: 110, data: '2025-09-04', entregadorId: 1, taxa: 8.50, status: 'Entregue' },
            { id: 111, data: '2025-09-04', entregadorId: 3, taxa: 7.00, status: 'Aguardando Coleta' },
            { id: 112, data: '2025-09-03', entregadorId: 2, taxa: 7.50, status: 'Entregue' },
            { id: 113, data: '2025-09-03', entregadorId: 1, taxa: 9.00, status: 'Entregue' },
            // Dados de meses anteriores
            { id: 114, data: '2025-08-30', entregadorId: 1, taxa: 8.00, status: 'Entregue' },
            { id: 115, data: '2025-08-25', entregadorId: 2, taxa: 7.00, status: 'Cancelado' },
            { id: 116, data: '2025-07-15', entregadorId: 3, taxa: 7.50, status: 'Entregue' },
            { id: 117, data: '2025-06-10', entregadorId: 1, taxa: 8.50, status: 'Entregue' },
        ];

        const statusColors = {
            'Entregue': 'bg-success',
            'Aguardando Coleta': 'bg-secondary',
            'Em Trânsito': 'bg-warning',
            'Cancelado': 'bg-danger',
        };

        const entregadoresTableBody = document.getElementById('entregadoresTableBody');
        const totalTaxasEntregadores = document.getElementById('totalTaxasEntregadores');
        const dataInicialInput = document.getElementById('dataInicial');
        const dataFinalInput = document.getElementById('dataFinal');
        const filtroNomeEntregadorInput = document.getElementById('filtroNomeEntregador');

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        function setInitialDates() {
            const hoje = new Date();
            const semanaAtras = new Date(hoje);
            semanaAtras.setDate(hoje.getDate() - 7);
            dataInicialInput.value = formatDate(semanaAtras);
            dataFinalInput.value = formatDate(hoje);
        }

        function renderTable(tableBody, data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Nenhum resultado encontrado.</td></tr>`;
            } else {
                data.forEach(item => {
                    const entregador = entregadores.find(e => e.id === item.entregadorId);
                    const nomeEntregador = entregador ? entregador.nome : 'N/A';
                    const badgeClass = statusColors[item.status] || 'bg-secondary';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-label="ID do Pedido">${item.id}</td>
                        <td data-label="Data">${formatDisplayDate(item.data)}</td>
                        <td data-label="Entregador">${nomeEntregador}</td>
                        <td data-label="Status"><span class="badge badge-status ${badgeClass}">${item.status}</span></td>
                        <td data-label="Taxa">R$ ${item.taxa.toFixed(2).replace('.', ',')}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        function atualizarRelatorioEntregadores() {
            const dataInicial = new Date(dataInicialInput.value + 'T00:00:00');
            const dataFinal = new Date(dataFinalInput.value + 'T23:59:59');
            const filtroNome = filtroNomeEntregadorInput.value.toLowerCase();
            let totalTaxas = 0;

            const pedidosFiltrados = pedidos.filter(p => {
                const dataPedido = new Date(p.data + 'T00:00:00');
                const entregador = entregadores.find(e => e.id === p.entregadorId);
                const nomeEntregador = entregador ? entregador.nome.toLowerCase() : '';
                return dataPedido >= dataInicial && dataPedido <= dataFinal && nomeEntregador.includes(filtroNome);
            });

            renderTable(entregadoresTableBody, pedidosFiltrados);

            pedidosFiltrados.forEach(p => {
                totalTaxas += p.taxa;
            });
            totalTaxasEntregadores.textContent = `R$ ${totalTaxas.toFixed(2).replace('.', ',')}`;
        }

        // Eventos para os filtros
        dataInicialInput.addEventListener('change', atualizarRelatorioEntregadores);
        dataFinalInput.addEventListener('change', atualizarRelatorioEntregadores);
        filtroNomeEntregadorInput.addEventListener('input', atualizarRelatorioEntregadores);

        // Executa o relatório inicial quando a página é carregada
        document.addEventListener('DOMContentLoaded', () => {
            setInitialDates();
            atualizarRelatorioEntregadores();
        });
    </script>
</body>

</html>